<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputArgument; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputDefinition; use Symfony\Component\Console\Output\OutputInterface; class FillQueueCommand extends Command { const INPUT_STORE_ID = "\163\x74\x6f\x72\145\x2d\x69\144"; const ENTITY_TYPE_CATEGORY = "\143\x61\164\x65\x67\157\162\171"; const ENTITY_TYPE_PRODUCT = "\160\x72\157\144\x75\143\164"; const URL_QUEUE_BATCH_SIZE = 2500; protected $logger; protected $storeManager; protected $categoryCollection; protected $urlQueueResource; protected $urlQueue; protected $numberOfUrls = 0; protected $categories = []; protected $state; public function __construct() { goto Aa160; Dd1f6: $this->urlQueue = $objectManager->get("\134\115\x67\x74\134\x56\x61\162\156\151\x73\x68\x5c\115\157\144\x65\x6c\134\x55\162\154\121\165\x65\165\145"); goto dda97; fe059: $this->storeManager = $objectManager->get("\134\x4d\x61\147\x65\156\164\x6f\134\x53\164\157\x72\x65\x5c\115\157\144\145\x6c\134\x53\x74\157\162\145\115\x61\x6e\x61\147\145\162\111\156\164\145\162\x66\x61\143\x65"); goto ede9b; Aa160: $objectManager = $this->getObjectManager(); goto A4465; Ff034: $this->urlQueueResource = $objectManager->get("\x5c\x4d\147\164\x5c\x56\x61\162\x6e\x69\163\150\134\x4d\157\x64\x65\x6c\134\122\x65\x73\157\165\x72\x63\x65\x4d\157\x64\x65\154\x5c\x55\162\154\x51\165\145\165\x65"); goto Dd1f6; A4465: $this->logger = $objectManager->get("\134\x50\x73\162\x5c\x4c\x6f\147\x5c\x4c\157\147\147\x65\x72\111\x6e\x74\x65\162\x66\x61\143\x65"); goto fe059; ede9b: $this->categoryCollection = $objectManager->get("\x5c\x4d\141\x67\145\x6e\164\157\134\103\141\x74\x61\x6c\x6f\x67\134\115\x6f\144\x65\154\x5c\x52\x65\163\157\x75\x72\x63\x65\115\x6f\x64\145\x6c\134\103\141\164\x65\x67\x6f\162\171\134\103\157\x6c\154\145\143\164\151\x6f\156"); goto Ff034; dda97: parent::__construct(); goto D24ad; D24ad: } protected function configure() { goto Ac88b; D4a9a: parent::configure(); goto d0250; D9254: $this->setDefinition(new InputDefinition(array(new InputOption(self::INPUT_STORE_ID, null, InputOption::VALUE_OPTIONAL, '')))); goto D4a9a; e924a: $this->setDescription("\115\x47\124\x20\x56\141\162\156\x69\163\150\40\x43\141\x63\150\145\40\121\165\x65\x75\x65\40\106\151\154\x6c\x65\x72"); goto D9254; Ac88b: $this->setName("\x6d\147\164\55\166\141\x72\156\151\x73\x68\72\x66\x69\x6c\154\x2d\x71\x75\145\x75\x65"); goto e924a; d0250: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto Bbb8a; A9dbd: if (!($this->numberOfUrls > 0)) { goto D3fb2; } goto C62a1; C06bf: $this->addProductUrls($store); goto A9dbd; Ff1f4: $storeId = (int) $input->getOption(self::INPUT_STORE_ID); goto d801e; Bbb8a: ini_set("\x6d\145\155\157\162\x79\x5f\x6c\x69\155\151\164", "\62\60\64\x38\115"); goto F8509; Bf622: Ab6d3: goto a5e2c; f0259: D3fb2: goto Dc29e; F93c4: try { $store = $this->storeManager->getStore($storeId); $this->storeManager->setCurrentStore($store); } catch (\Exception $e) { goto b8b88; D3028: $output->writeln(''); goto E1841; E1841: $output->writeln(sprintf("\74\143\x6f\x6d\155\145\156\164\x3e\101\x76\x61\151\154\x61\x62\154\x65\40\x53\164\157\162\x65\x73\x3c\x2f\143\x6f\155\x6d\x65\x6e\164\x3e")); goto C70d6; C70d6: return $this->showStores($output); goto d10e3; b8b88: $output->writeln(sprintf("\74\x65\x72\162\x6f\x72\x3e\x53\x74\x6f\162\145\x20\x77\x69\x74\x68\40\111\104\40\42\x25\x73\x22\40\144\157\x65\x73\40\x6e\157\164\40\x65\x78\151\163\164\163\x3c\57\x65\162\x72\x6f\162\76", $storeId)); goto D3028; d10e3: } goto Bf622; a5e2c: $this->addCategoryUrls($store); goto C06bf; d801e: if (!$storeId) { goto Ab6d3; } goto F93c4; C62a1: $output->writeln(sprintf("\x3c\x69\x6e\x66\x6f\x3e\x25\163\40\125\122\x4c\x73\x20\141\x64\x64\145\x64\40\x74\x6f\x20\126\x61\162\x6e\x69\x73\x68\40\x51\165\x65\165\x65\x3c\57\x69\x6e\146\x6f\76", $this->numberOfUrls)); goto f0259; F8509: $store = null; goto Ff1f4; Dc29e: } catch (\Exception $e) { goto B5bc0; bfd4c: $output->writeln(sprintf("\74\x65\x72\162\157\x72\x3e\45\x73\x3c\x2f\145\162\162\157\x72\76", $errorMessage)); goto A4424; B5bc0: $errorMessage = $e->getMessage(); goto bfd4c; A4424: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto Aa42a; Aa42a: } } protected function addCategoryUrls(\Magento\Store\Model\Store $store = null) { goto Be13d; A0350: $urls = []; goto B8329; B8329: foreach ($urlRewriteCollection as $urlRewrite) { goto a5a31; a671a: $urls[] = ["\163\x74\x6f\x72\145\137\x69\144" => $urlRewrite->getStoreId(), "\160\141\x74\x68" => $urlRewrite->getRequestPath(), "\x70\x72\x69\157\x72\151\164\x79" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_MEDIUM]; goto e79fa; d79af: if (isset($urlRewrites[$urlRewriteId])) { goto A0351; } goto a671a; bfa64: d39b9: goto f75ab; a5a31: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto d79af; e79fa: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto Af2f0; Af2f0: A0351: goto bfa64; f75ab: } goto e65ff; Ba43a: $this->categoryCollection->addAttributeToSelect("\x65\x6e\x74\x69\164\171\137\x69\144"); goto c652c; C3656: d0403: goto Fbafe; Fbafe: if (!count($this->categories)) { goto c92b5; } goto a43ab; e65ff: c38ef: goto D5e7b; dfdfd: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_CATEGORY); goto f8219; f8219: $urlRewriteCollection->addEntityIdFilter($categoryIds); goto d6381; D5e7b: if (!count($urls)) { goto e2281; } goto Dea61; E0123: e2281: goto d35cf; B1cd2: $this->urlQueue->addToQueue($urls); goto E0123; Be13d: $objectManager = $this->getObjectManager(); goto b3c5c; Be3c3: $this->categoryCollection->setStore($store); goto a0dbc; Dea61: $this->numberOfUrls += count($urls); goto B1cd2; Cfa73: A1c72: goto Ba43a; a0dbc: $urlRewriteCollection->addStoreFilter($storeId, false); goto Cfa73; c652c: foreach ($this->categoryCollection as $category) { $this->categories[$category->getId()] = $category; F6cb3: } goto C3656; b3c5c: $urlRewriteCollection = $objectManager->create("\134\115\x67\x74\x5c\126\141\x72\x6e\x69\x73\150\x5c\115\x6f\144\x65\x6c\134\122\x65\x73\157\165\162\143\145\115\157\144\145\154\134\125\162\x6c\122\145\x77\162\151\x74\145\134\125\162\154\x52\145\167\x72\x69\x74\145\103\157\x6c\154\x65\143\164\151\x6f\x6e"); goto c7c18; c7c18: if (!(null !== $store)) { goto A1c72; } goto D2403; a43ab: $categoryIds = array_keys($this->categories); goto dfdfd; D2403: $storeId = $store->getStoreId(); goto Be3c3; d35cf: c92b5: goto De3e9; d6381: $urlRewrites = []; goto A0350; De3e9: } protected function addProductUrls(\Magento\Store\Model\Store $store = null) { goto C762d; Cda2d: ff9ee: goto C162a; C762d: if (!count($this->categories)) { goto ff9ee; } goto Fd280; d7ac4: $productVisibility = $objectManager->get("\x5c\115\141\x67\145\156\x74\157\x5c\x43\141\164\x61\x6c\x6f\147\134\x4d\157\x64\145\154\134\x50\x72\157\x64\x75\x63\164\x5c\x56\151\x73\151\142\151\x6c\151\164\171"); goto B729c; D0a64: D37fc: goto Cda2d; Fd280: $objectManager = $this->getObjectManager(); goto aafa5; C02ab: $productStatus = $objectManager->get("\x5c\115\141\147\x65\x6e\x74\x6f\x5c\103\x61\x74\141\154\157\147\134\115\x6f\144\145\154\134\120\x72\x6f\x64\165\143\x74\134\x41\x74\x74\162\x69\x62\165\x74\145\134\x53\x6f\x75\x72\143\145\134\x53\164\141\x74\x75\163"); goto d7ac4; F6da1: foreach ($this->categories as $category) { goto A66d9; a8467: $urls = []; goto Cbc4c; dce2e: $urlRewriteCollection->addStoreFilter($storeId, false); goto c628a; f58b9: $productCollection->setVisibility($productVisibility->getVisibleInSiteIds()); goto bd86b; b5e45: $productCollection->addAttributeToSelect(["\145\x6e\x74\x69\x74\x79\137\x69\144", "\x73\164\x61\x74\x75\x73"]); goto Dabf6; Bd450: $productCollection->addStoreFilter($store); goto da877; Dabf6: $productCollection->addAttributeToFilter("\163\164\141\x74\x75\163", ["\x69\156" => $productStatus->getVisibleStatusIds()]); goto f58b9; E2e04: Bfb41: goto E5a23; Bf44e: dbb22: goto Ecbda; A66d9: $productCollection = $objectManager->create("\134\x4d\x61\x67\x65\x6e\x74\157\x5c\103\x61\x74\x61\154\157\147\x5c\x4d\157\144\145\154\134\x52\145\163\x6f\165\162\143\145\x4d\x6f\144\x65\x6c\134\x50\x72\x6f\144\165\x63\164\x5c\103\x6f\154\x6c\x65\143\164\x69\157\x6e"); goto b5e45; A9df2: $urlRewriteCollection = $objectManager->create("\x5c\115\147\164\x5c\x56\x61\x72\156\151\x73\150\x5c\115\x6f\x64\145\x6c\134\x52\145\163\157\x75\x72\143\x65\115\x6f\144\x65\x6c\x5c\125\x72\154\122\145\167\162\x69\164\x65\x5c\125\162\x6c\122\145\x77\162\x69\x74\145\x43\157\x6c\154\x65\x63\x74\x69\157\x6e"); goto da430; bbe41: if (!(null !== $store)) { goto Ae9ce; } goto Bd450; Cbc4c: foreach ($urlRewriteCollection as $urlRewrite) { goto Bc07c; Bc07c: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto Daa9b; E553c: c97d6: goto A9415; Daa9b: if (isset($urlRewrites[$urlRewriteId])) { goto c97d6; } goto b8639; b8639: $urls[] = ["\x73\x74\x6f\x72\x65\x5f\x69\144" => $urlRewrite->getStoreId(), "\160\141\164\x68" => $urlRewrite->getRequestPath(), "\x70\162\151\x6f\x72\x69\x74\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_LOW]; goto A7c90; A9415: Ac1c0: goto Fe616; A7c90: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto E553c; Fe616: } goto E4e13; fe79a: $i = 0; goto E2e04; c628a: D574f: goto Cb6d1; cd0a4: b2a73: goto cde57; E4e13: E3058: goto E333e; Aa0d4: $break = false; goto fe79a; e185f: a5f60: goto A9df2; e30f5: $this->numberOfUrls += count($urls); goto dc18b; b4a07: $entityIds = []; goto Fe825; E333e: if (!count($urls)) { goto Acae8; } goto e30f5; af6b0: $productCollection->setPageSize(self::URL_QUEUE_BATCH_SIZE); goto b4a07; E5a23: $productCollection->clear(); goto bbe41; Cb6d1: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_PRODUCT); goto d0502; da877: Ae9ce: goto b6062; f01f6: d18aa: goto cd0a4; dc18b: $this->urlQueue->addToQueue($urls); goto Bcb48; Fe825: foreach ($productCollection as $product) { goto Afeb0; e60fc: $productIds[$productId] = $productId; goto Dfb18; D7499: B5253: goto D0a59; B494f: $entityIds[$productId] = $productId; goto c8e4d; E3d5c: goto C1526; goto Ec945; Ec945: d5573: goto a63a0; a63a0: $productIds[$productId] = $productId; goto B494f; Afeb0: $productId = $product->getId(); goto ab96f; B1b58: ef4ef: goto E3d5c; ab96f: if (isset($productIds[$productId])) { goto a410d; } goto Cc8f7; E86a0: $parentIds = $configurableProduct->getParentIdsByChild($productId); goto dc045; dc045: if (!(true === empty($parentIds))) { goto ef4ef; } goto e60fc; E9c01: a410d: goto D7499; Cc8f7: if ("\x63\157\x6e\146\151\147\x75\x72\141\x62\x6c\145" == $product->getTypeId()) { goto d5573; } goto E86a0; Dfb18: $entityIds[$productId] = $productId; goto B1b58; c8e4d: C1526: goto E9c01; D0a59: } goto Aa2bd; Bcb48: Acae8: goto Bf44e; Ecbda: if ($break == false) { goto Bfb41; } goto f01f6; f11c6: $storeId = $store->getStoreId(); goto dce2e; d0502: $urlRewriteCollection->addEntityIdFilter($entityIds); goto E9f71; Aa2bd: dbbb3: goto d6ff6; d6ff6: if (false === empty($entityIds)) { goto a5f60; } goto dd888; da430: if (!(null !== $store)) { goto D574f; } goto f11c6; bd86b: $productCollection->addCategoryFilter($category); goto Aa0d4; dd888: $break = true; goto efdfa; efdfa: goto dbb22; goto e185f; E9f71: $urlRewrites = []; goto a8467; b6062: $productCollection->setCurPage(++$i); goto af6b0; cde57: } goto D0a64; B729c: $productIds = []; goto F6da1; aafa5: $configurableProduct = $objectManager->get("\x5c\115\x61\147\145\x6e\164\157\134\x43\x6f\156\146\151\x67\165\x72\141\x62\154\145\120\162\157\144\165\143\164\134\115\x6f\x64\145\154\x5c\122\145\163\x6f\x75\x72\x63\145\115\x6f\x64\145\154\134\x50\x72\157\144\x75\x63\x74\134\124\171\160\x65\x5c\103\157\x6e\146\x69\x67\165\162\x61\x62\x6c\145"); goto C02ab; C162a: } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } protected function showStores(OutputInterface $output) { goto F6007; D2cbf: $stores = $this->storeManager->getStores(); goto ca9de; F659a: eb592: goto De457; F6007: $table = $this->getHelperSet()->get("\164\141\x62\154\x65"); goto Ef4e8; De457: $table->render($output); goto d0de2; ca9de: foreach ($stores as $store) { goto fcbd3; D1808: $table->addRow($row); goto ae20f; fcbd3: $row = [$store->getStoreId(), $store->getBaseUrl()]; goto D1808; ae20f: db275: goto f78d6; f78d6: } goto F659a; Ef4e8: $table->setHeaders(["\123\164\157\x72\145\x20\x49\x44", "\x42\x61\x73\145\x20\125\122\x4c"]); goto D2cbf; d0de2: } }
