<?php
 namespace Mgt\Varnish\Model\Plugin; class LayoutPlugin { const ADMIN_AREA_CODE = "\141\x64\x6d\151\156\150\x74\x6d\x6c"; protected $request; protected $storeConfig; protected $varnishConfig; protected $response; protected $license; protected $logger; protected $cacheLifetime; protected $state; public function __construct() { goto D39f5; d0794: $this->request = $objectManager->get("\134\115\x61\x67\145\156\x74\x6f\134\x46\162\x61\x6d\145\167\157\x72\153\134\x41\x70\x70\x5c\x52\x65\x71\165\145\x73\164\134\x48\164\164\160"); goto A16d1; E966e: $this->varnishConfig = $objectManager->get("\134\x4d\147\x74\x5c\x56\x61\x72\x6e\x69\x73\150\134\x4d\x6f\144\x65\x6c\134\103\141\143\x68\145\x5c\x43\157\156\x66\x69\147"); goto Be324; Be324: $this->license = $objectManager->get("\x5c\x4d\x67\164\134\x56\141\162\156\151\163\150\x5c\x4d\x6f\144\145\154\134\114\x69\143\145\x6e\163\x65"); goto b9911; f193f: $this->storeConfig = $objectManager->get("\x5c\x4d\x61\x67\145\156\164\157\134\120\141\x67\x65\103\141\x63\150\x65\134\115\157\144\x65\154\x5c\x43\157\156\146\x69\x67"); goto E966e; A16d1: $this->response = $objectManager->get("\x5c\x4d\x61\x67\145\x6e\164\157\134\x46\162\141\155\x65\167\157\162\153\x5c\101\160\160\x5c\122\x65\163\160\157\x6e\x73\x65\111\156\x74\x65\x72\x66\x61\x63\145"); goto f193f; b9911: $this->state = $objectManager->get("\134\115\x61\147\x65\156\164\x6f\x5c\106\x72\x61\155\145\x77\157\x72\x6b\134\x41\160\160\x5c\123\164\141\164\x65"); goto Ed806; D39f5: $objectManager = $this->getObjectManager(); goto d0794; Ed806: $this->logger = $objectManager->get("\134\x50\163\x72\x5c\114\x6f\x67\x5c\x4c\157\147\147\145\x72\x49\156\164\x65\162\146\141\x63\x65"); goto Fe6ab; Fe6ab: } public function afterGetOutput(\Magento\Framework\View\Layout $subject, $result) { goto d2dbf; da179: $this->response->setNoCacheHeaders(); goto c977b; D62c5: $this->setResponseHeaders($tags); goto Be14b; Be14b: $this->saveUrlInformation($tags); goto Cbccb; d2dbf: $isCacheable = $this->isCacheable($subject); goto b1935; Cbccb: c4b2f: goto bd29d; b1935: if (true === $isCacheable) { goto a1f58; } goto da179; c977b: $this->response->setHeader("\x58\x2d\103\141\143\x68\x65\55\114\x69\x66\145\164\151\x6d\145", 0); goto f3dd2; e808a: foreach ($subject->getAllBlocks() as $block) { goto Afddb; C786a: $tags = array_merge($tags, $block->getIdentities()); goto b431f; A8e7f: F5464: goto a2eb4; ce578: goto F5464; goto db712; f1570: if (!($isVarnish && $isEsiBlock)) { goto f9d12; } goto ce578; c6032: $isVarnish = $this->storeConfig->getType() == \Magento\PageCache\Model\Config::VARNISH; goto f1570; db712: f9d12: goto C786a; b431f: B9e2f: goto A8e7f; fa9b9: $isEsiBlock = $block->getTtl() > 0; goto c6032; Afddb: if (!$block instanceof \Magento\Framework\DataObject\IdentityInterface) { goto B9e2f; } goto fa9b9; a2eb4: } goto Fbe76; bd29d: return $result; goto E1008; B277a: $tags = array_unique($tags); goto D62c5; B2c33: $tags = []; goto e808a; Fbe76: ce981: goto B277a; e21b6: a1f58: goto B2c33; f3dd2: goto c4b2f; goto e21b6; E1008: } protected function isCacheable(\Magento\Framework\View\Layout $subject) { goto f166b; eba17: if (!(true === $isAdminStore)) { goto B34df; } goto cff5b; a734b: $excludedParams = $this->varnishConfig->getExcludedParams(); goto b547e; A5f95: $requestStringWithoutSlash = rtrim($requestString, "\x2f"); goto a8790; Fba91: $isMgt = isset($_SERVER["\115\x47\x54"]) && $_SERVER["\x4d\x47\x54"] == "\61" ? true : false; goto f19b2; Cdf13: c9c6c: goto a734b; A17e5: return false; goto Aa79f; Aa79f: c7d79: goto C20cb; ae0a6: foreach ($excludedUrls as $excludedUrl) { goto ce761; ce761: $excludedUrl = trim($excludedUrl); goto A41b3; ae8b6: return false; goto a65fa; b9b85: e5b8c: goto f6797; A41b3: if (!($excludedUrl && true === in_array($excludedUrl, [$requestStringWithoutSlash, $requestStringWithSlash]))) { goto A1203; } goto ae8b6; a65fa: A1203: goto b9b85; f6797: } goto ee0ac; Fa624: $requestString = ltrim($this->request->getRequestString(), "\57"); goto A5f95; C20cb: $currentHost = isset($_SERVER["\110\124\124\120\137\110\117\123\124"]) ? $_SERVER["\x48\124\x54\x50\137\110\117\123\124"] : ''; goto Edc2c; Fd982: if (!(false === $hasLicense)) { goto c9c6c; } goto E1349; bc032: $fullActionName = $this->request->getFullActionName(); goto Cbb27; eb7bc: $isAdminStore = $this->isAdminStore(); goto eba17; E1349: return false; goto Cdf13; bf590: return true; goto cc93d; b25cd: return false; goto Db138; b547e: foreach ($excludedParams as $param) { goto Ad9ad; C5915: Ef153: goto a013e; a013e: Bd21f: goto Bf175; B5d2b: return false; goto C5915; Ad9ad: if (!$this->request->getParam(trim($param))) { goto Ef153; } goto B5d2b; Bf175: } goto F6858; Db138: f0e21: goto eb7bc; ee0ac: Dd736: goto bc032; Aa9c3: $isVarnishEnabled = $this->varnishConfig->isEnabled(); goto Bf37c; a8790: $requestStringWithSlash = sprintf("\45\x73\57", $requestStringWithoutSlash); goto Cbf8b; Cbf8b: $excludedUrls = $this->varnishConfig->getExcludedUrls(); goto ae0a6; f19b2: if (!(false === $isMgt)) { goto c7d79; } goto A17e5; d88f6: B34df: goto Fba91; Edc2c: $hasLicense = $this->license->hasLicense($currentHost); goto Fd982; F6858: b6ea8: goto Fa624; Cbb27: $excludedRoutes = $this->varnishConfig->getExcludedRoutes(); goto c8cf0; f166b: $isFullPageCacheEnabled = $this->storeConfig->isEnabled(); goto Aa9c3; cff5b: return false; goto d88f6; Bf37c: if (!(false === $isFullPageCacheEnabled || false === $isVarnishEnabled)) { goto f0e21; } goto b25cd; c8cf0: foreach ($excludedRoutes as $route) { goto e74be; cdda8: fd915: goto D8d56; e74be: $route = trim($route); goto E8655; E8655: if (!(!empty($route) && strpos($fullActionName, $route) === 0)) { goto fd915; } goto c4120; D8d56: ba81b: goto bafa5; c4120: return false; goto cdda8; bafa5: } goto Fc335; Fc335: e5eaf: goto bf590; cc93d: } public function setResponseHeaders(array $tags) { goto d6d80; cbd02: d7406: goto F6e0c; cdda6: $this->response->setPublicHeaders($this->cacheLifetime); goto C65f5; f0529: bb36e: goto f1cb0; f113d: $routesCacheLifetime = $this->varnishConfig->getRoutesCacheLifetime(); goto afb79; b0434: $isDebugModeEnabled = $this->varnishConfig->isDebugModeEnabled(); goto C2c57; f1cb0: $this->response->setHeader("\x58\x2d\115\x61\x67\x65\156\x74\157\x2d\124\x61\147\x73", implode("\x2c", $tags)); goto cdda6; afb79: if (!($routesCacheLifetime && count($routesCacheLifetime))) { goto Bfa60; } goto Dd068; Cc504: $this->response->setHeader("\130\55\103\141\143\x68\145\55\104\x65\x62\165\x67", 1); goto A06cb; Dd068: foreach ($routesCacheLifetime as $routeConfig) { goto E81c2; E81c2: $route = isset($routeConfig["\146\x69\x65\x6c\x64\61"]) ? trim($routeConfig["\x66\x69\x65\154\x64\61"]) : ''; goto Bf9c6; A7d42: $this->cacheLifetime = $routeCacheLifetime; goto ffbc7; Bf9c6: $routeCacheLifetime = isset($routeConfig["\146\x69\145\154\144\62"]) ? $routeConfig["\146\151\x65\154\x64\62"] : ''; goto Dd55f; d450a: ee9b2: goto B835d; Dd55f: if (!($route && $fullActionName == $route)) { goto baaf8; } goto A7d42; ffbc7: goto d7406; goto B1d75; B1d75: baaf8: goto d450a; B835d: } goto cbd02; C65f5: $this->response->setHeader("\x58\55\x43\141\143\x68\145\x2d\114\x69\146\x65\164\x69\x6d\145", $this->cacheLifetime); goto B4284; F6e0c: Bfa60: goto Aeecb; d6d80: $this->cacheLifetime = $this->varnishConfig->getDefaultCacheLifetime(); goto b0434; A06cb: $this->response->setHeader("\x58\55\115\141\147\x65\x6e\164\x6f\55\122\157\165\x74\145", $fullActionName); goto f0529; Aeecb: if (!(true === $isDebugModeEnabled)) { goto bb36e; } goto Cc504; C2c57: $fullActionName = $this->request->getFullActionName(); goto f113d; B4284: } protected function saveUrlInformation(array $tags) { goto Cfa8f; Cfa8f: $canSaveUrlInformation = $this->canSaveUrlInformation(); goto f4619; Fa8c8: try { goto e57da; aabe4: $url->setCacheExpiredAt($cacheExpiredAt); goto Cbb16; e57da: $objectManager = $this->getObjectManager(); goto bc0ff; B4ca5: F2660: goto D0712; D7007: $storeId = $store->getStoreId(); goto a890e; bc76e: $cacheExpiredAt->add(new \DateInterval(sprintf("\120\124\45\163\123", $this->cacheLifetime))); goto e1ea2; d03fd: $path = "\x2f" . substr($path, strlen($storeBaseUri->getPath())); goto B4ca5; bc0ff: $storeManager = $objectManager->get("\134\x4d\141\x67\x65\156\164\x6f\x5c\x53\x74\x6f\162\x65\x5c\x4d\157\144\145\x6c\134\x53\164\x6f\162\x65\x4d\141\x6e\x61\147\x65\162\x49\x6e\164\145\162\146\x61\143\145"); goto Ca901; D34fd: $url->setStoreId($storeId); goto f2ac4; e1ea2: $cacheExpiredAt = $cacheExpiredAt->format("\131\55\x6d\x2d\144\x20\110\72\x69\x3a\x73"); goto D34fd; Ca901: $store = $storeManager->getStore(); goto D7007; D0712: $url = $objectManager->create("\x4d\x67\164\x5c\x56\141\x72\156\151\x73\150\134\115\157\144\145\x6c\x5c\125\x72\x6c"); goto fa2ef; bc49f: $url = $objectManager->create("\x4d\x67\x74\x5c\x56\x61\x72\x6e\151\x73\x68\x5c\x4d\x6f\x64\145\154\x5c\x55\162\154"); goto f0b0a; Cbb16: $url->save(); goto E310d; Cfdc0: $url->setCacheLifetime($this->cacheLifetime); goto aabe4; Ddb02: if (!$url->getId()) { goto a530d; } goto B59fc; fe20e: if (!($storeBaseUri->getPath() != "\57")) { goto F2660; } goto d03fd; a890e: $storeBaseUri = new \Laminas\Uri\Uri($store->getBaseUrl()); goto B4295; f2ac4: $url->setPath($path); goto b4190; B4295: $path = $this->request->getRequestUri(); goto fe20e; a6220: $cacheExpiredAt = new \DateTime("\x6e\x6f\x77", new \DateTimeZone("\x55\x54\x43")); goto bc76e; b4190: $url->setTags($tags); goto Cfdc0; fa2ef: $url->loadByStoreIdAndPath($storeId, $path); goto Ddb02; f0b0a: a530d: goto a6220; B59fc: $url->delete(); goto bc49f; E310d: } catch (\Exception $e) { $this->logger->critical($e); } goto Aeeca; f4619: if (!(true === $canSaveUrlInformation)) { goto A30d5; } goto Fa8c8; Aeeca: A30d5: goto Db44d; Db44d: } protected function canSaveUrlInformation() { goto e4aa5; Ed1bd: c32f7: goto ea646; Ad2af: fae6c: goto a83f7; D4a76: if (!(false === $cacheWarmerRouteFound)) { goto c32f7; } goto c8e2c; b96f6: if (!count($requestParams)) { goto Cb9a1; } goto dffc9; dffc9: return false; goto de8c3; C9bbe: if (!(true === $isAdminStore)) { goto fae6c; } goto a8a37; Dfae5: if (!(false === $isCacheWarmerEnabled)) { goto Eefcc; } goto e569e; ad731: foreach ($cacheWarmerRoutes as $cacheWarmerRoute) { goto C416a; eaf21: goto a87c3; goto bd033; bd033: A52c8: goto a295f; b4e13: $cacheWarmerRouteFound = true; goto eaf21; a295f: C218f: goto Fc16b; C416a: if (!($cacheWarmerRoute == $fullActionName)) { goto A52c8; } goto b4e13; Fc16b: } goto d388a; e4aa5: $isAdminStore = $this->isAdminStore(); goto C9bbe; d388a: a87c3: goto D4a76; C54f8: $cacheWarmerRouteFound = false; goto C61f4; ea646: return true; goto F3c9c; D56c5: $requestParams = (array) $this->request->getQuery(); goto b96f6; de8c3: Cb9a1: goto C54f8; b0795: $cacheWarmerRoutes = $this->varnishConfig->getCacheWarmerRoutes(); goto ad731; e569e: return false; goto Fa531; C61f4: $fullActionName = $this->request->getFullActionName(); goto b0795; c8e2c: return false; goto Ed1bd; Fa531: Eefcc: goto D56c5; a83f7: $isCacheWarmerEnabled = $this->varnishConfig->isCacheWarmerEnabled(); goto Dfae5; a8a37: return false; goto Ad2af; F3c9c: } protected function isAdminStore() { $isAdminStore = $this->state->getAreaCode() == self::ADMIN_AREA_CODE; return $isAdminStore; } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } }
